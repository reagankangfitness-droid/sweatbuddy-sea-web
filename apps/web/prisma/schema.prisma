generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum ActivityType {
  RUN
  GYM
  YOGA
  HIKE
  CYCLING
  OTHER
}

enum ActivityStatus {
  DRAFT
  PUBLISHED
  CANCELLED
  COMPLETED
}

enum UserActivityStatus {
  INTERESTED
  JOINED
  CANCELLED
  COMPLETED
}

enum GroupPrivacy {
  PUBLIC
  PRIVATE
}

enum UserRole {
  MEMBER
  ADMIN
}

// Models
model User {
  id        String    @id @default(cuid())
  email     String    @unique
  name      String?
  imageUrl  String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  activities              Activity[]            @relation("CreatedActivities")
  hostedActivities        Activity[]            @relation("HostedActivities")
  groups                  UserGroup[]
  messages                Message[]
  userActivities          UserActivity[]
  sentConversations       Conversation[]        @relation("SentConversations")
  receivedConversations   Conversation[]        @relation("ReceivedConversations")
  conversationMessages    ConversationMessage[]
  referralInvitesSent     ReferralInvite[]      @relation("ReferralInvitesSent")
  referralConversions     ReferralConversion[]  @relation("ReferralConversions")
  referralStats           UserReferralStats?
  workoutBuddiesAsUser    WorkoutBuddy[]        @relation("WorkoutBuddiesAsUser")
  workoutBuddiesAsBuddy   WorkoutBuddy[]        @relation("WorkoutBuddiesAsBuddy")

  @@map("users")
}

model Activity {
  id          String         @id @default(cuid())
  title       String
  description String?
  type        ActivityType
  city        String
  latitude    Float
  longitude   Float
  // Additional location fields for Google Places data
  address       String?        // Full formatted address (e.g., "Red Dot Design Museum, 11 Marina Blvd, Singapore 018940")
  streetAddress String?        // Street portion (e.g., "11 Marina Blvd")
  postalCode    String?        // Postal/ZIP code
  country       String?        // Country name
  placeId       String?        // Google Places ID for reference
  startTime   DateTime?
  endTime     DateTime?
  maxPeople   Int?
  imageUrl    String?
  price       Float          @default(0)
  currency    String         @default("USD")
  status      ActivityStatus @default(PUBLISHED)
  userId      String
  hostId      String?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  deletedAt   DateTime?

  user           User             @relation("CreatedActivities", fields: [userId], references: [id])
  host           User?            @relation("HostedActivities", fields: [hostId], references: [id])
  userActivities UserActivity[]
  groups         Group[]
  conversations  Conversation[]
  referralInvites ReferralInvite[]
  workoutBuddies WorkoutBuddy[]

  @@index([userId])
  @@index([hostId])
  @@index([type])
  @@index([city])
  @@index([startTime])
  @@index([title])
  @@index([status])
  @@index([placeId])
  @@map("activities")
}

model Group {
  id          String       @id @default(cuid())
  name        String
  description String?
  privacy     GroupPrivacy @default(PUBLIC)
  activityId  String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  deletedAt   DateTime?

  activity Activity?   @relation(fields: [activityId], references: [id])
  members  UserGroup[]
  messages Message[]

  @@index([activityId])
  @@map("groups")
}

model Message {
  id        String    @id @default(cuid())
  content   String
  groupId   String
  userId    String
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  group Group @relation(fields: [groupId], references: [id])
  user  User  @relation(fields: [userId], references: [id])

  @@index([groupId])
  @@index([userId])
  @@map("messages")
}

model UserGroup {
  id        String    @id @default(cuid())
  userId    String
  groupId   String
  role      UserRole  @default(MEMBER)
  joinedAt  DateTime  @default(now())
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  user  User  @relation(fields: [userId], references: [id])
  group Group @relation(fields: [groupId], references: [id])

  @@unique([userId, groupId])
  @@index([userId])
  @@index([groupId])
  @@map("user_groups")
}

// Payment status enum
enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
  FREE
  EXPIRED
}

model UserActivity {
  id         String             @id @default(cuid())
  userId     String
  activityId String
  status     UserActivityStatus @default(INTERESTED)
  createdAt  DateTime           @default(now())
  updatedAt  DateTime           @updatedAt
  deletedAt  DateTime?

  // Payment tracking fields
  paymentStatus             PaymentStatus? @default(PENDING)
  stripeCheckoutSessionId   String?
  stripePaymentIntentId     String?
  amountPaid                Float?
  currency                  String?        @default("SGD")
  paidAt                    DateTime?
  refundedAt                DateTime?
  refundAmount              Float?

  user     User      @relation(fields: [userId], references: [id])
  activity Activity  @relation(fields: [activityId], references: [id])
  payment  Payment?

  @@unique([userId, activityId])
  @@index([userId])
  @@index([activityId])
  @@index([status])
  @@index([stripeCheckoutSessionId])
  @@map("user_activities")
}

// Detailed payment tracking for audit trail
model Payment {
  id             String        @id @default(cuid())
  userActivityId String        @unique
  userId         String
  activityId     String
  hostId         String?

  // Stripe IDs
  stripeCheckoutSessionId String?
  stripePaymentIntentId   String?
  stripeCustomerId        String?

  // Payment details
  amount         Float
  currency       String        @default("SGD")
  status         PaymentStatus @default(PENDING)

  // Fees tracking (for future use)
  stripeFee      Float?
  platformFee    Float?
  hostPayout     Float?

  // Discount tracking
  originalAmount  Float?
  discountAmount  Float?
  discountCode    String?
  referralInviteId String?

  // Metadata
  description    String?
  metadata       Json?

  // Timestamps
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  paidAt         DateTime?
  refundedAt     DateTime?

  userActivity   UserActivity  @relation(fields: [userActivityId], references: [id])

  @@index([userId])
  @@index([activityId])
  @@index([stripeCheckoutSessionId])
  @@index([stripePaymentIntentId])
  @@index([status])
  @@map("payments")
}

model Conversation {
  id         String    @id @default(cuid())
  activityId String
  senderId   String
  receiverId String
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  deletedAt  DateTime?

  activity Activity              @relation(fields: [activityId], references: [id])
  sender   User                  @relation("SentConversations", fields: [senderId], references: [id])
  receiver User                  @relation("ReceivedConversations", fields: [receiverId], references: [id])
  messages ConversationMessage[]

  @@unique([activityId, senderId, receiverId])
  @@index([activityId])
  @@index([senderId])
  @@index([receiverId])
  @@map("conversations")
}

model ConversationMessage {
  id             String    @id @default(cuid())
  conversationId String
  userId         String
  content        String
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  deletedAt      DateTime?

  conversation Conversation @relation(fields: [conversationId], references: [id])
  user         User         @relation(fields: [userId], references: [id])

  @@index([conversationId])
  @@index([userId])
  @@map("conversation_messages")
}

// Referral System Models
enum ReferralInviteStatus {
  PENDING
  CLICKED
  CONVERTED
  EXPIRED
}

enum DiscountType {
  PERCENTAGE
  FIXED
  FREE
}

model ReferralInvite {
  id         String                @id @default(cuid())
  referrerId String
  activityId String
  inviteCode String                @unique
  inviteLink String
  status     ReferralInviteStatus  @default(PENDING)

  friendEmail String?
  friendName  String?

  createdAt   DateTime  @default(now())
  expiresAt   DateTime
  clickedAt   DateTime?
  convertedAt DateTime?
  deletedAt   DateTime?

  referrerRewardClaimed  Boolean @default(false)
  friendDiscountApplied  Boolean @default(false)

  referrer    User                  @relation("ReferralInvitesSent", fields: [referrerId], references: [id])
  activity    Activity              @relation(fields: [activityId], references: [id])
  conversions ReferralConversion[]

  @@index([referrerId])
  @@index([activityId])
  @@index([inviteCode])
  @@index([status])
  @@map("referral_invites")
}

model ReferralConversion {
  id             String       @id @default(cuid())
  inviteId       String
  friendUserId   String
  userActivityId String?

  discountType   DiscountType
  discountValue  Float
  discountAmount Float

  convertedAt DateTime @default(now())
  deletedAt   DateTime?

  invite       ReferralInvite @relation(fields: [inviteId], references: [id])
  friendUser   User           @relation("ReferralConversions", fields: [friendUserId], references: [id])

  @@index([inviteId])
  @@index([friendUserId])
  @@map("referral_conversions")
}

model UserReferralStats {
  userId String @id

  totalInvitesSent Int @default(0)
  totalClicks      Int @default(0)
  totalConversions Int @default(0)

  totalCreditsEarned   Float @default(0)
  currentCreditBalance Float @default(0)

  badges Json  @default("[]")

  currentStreak Int @default(0)
  longestStreak Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@map("user_referral_stats")
}

model WorkoutBuddy {
  id String @id @default(cuid())

  userId  String
  buddyId String

  firstActivityId String
  connectedVia    String @default("referral")

  activitiesTogether Int      @default(1)
  firstWorkoutDate   DateTime @default(now())
  lastWorkoutDate    DateTime @default(now())

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  user          User     @relation("WorkoutBuddiesAsUser", fields: [userId], references: [id])
  buddy         User     @relation("WorkoutBuddiesAsBuddy", fields: [buddyId], references: [id])
  firstActivity Activity @relation(fields: [firstActivityId], references: [id])

  @@unique([userId, buddyId])
  @@index([userId])
  @@index([buddyId])
  @@map("workout_buddies")
}
