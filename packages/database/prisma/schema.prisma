generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum ActivityType {
  RUN
  GYM
  YOGA
  HIKE
  CYCLING
  OTHER
}

enum ActivityStatus {
  DRAFT
  PUBLISHED
  CANCELLED
  COMPLETED
}

enum UserActivityStatus {
  INTERESTED
  JOINED
  CANCELLED
  COMPLETED
}

enum GroupPrivacy {
  PUBLIC
  PRIVATE
}

enum UserRole {
  MEMBER
  ADMIN
}

enum NotificationType {
  MENTION
  MESSAGE
  ACTIVITY_UPDATE
  JOIN_REQUEST
  SYSTEM
  NUDGE
}

// Models
model User {
  id        String    @id @default(cuid())
  email     String    @unique
  name      String?
  imageUrl  String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  activities              Activity[]              @relation("CreatedActivities")
  hostedActivities        Activity[]              @relation("HostedActivities")
  groups                  UserGroup[]
  messages                Message[]
  userActivities          UserActivity[]
  notifications           Notification[]          @relation("UserNotifications")
  mentionsSent            Mention[]               @relation("MentionsSent")
  mentionsReceived        Mention[]               @relation("MentionsReceived")
  notificationPreferences NotificationPreference?

  @@map("users")
}

model Activity {
  id          String         @id @default(cuid())
  title       String
  description String?
  type        ActivityType
  city        String
  address     String?        // Full formatted address
  streetAddress String?      // Street address (e.g., "123 Orchard Road")
  postalCode  String?        // Postal/ZIP code
  country     String?        // Country
  placeId     String?        // Google Maps Place ID for deep linking
  latitude    Float
  longitude   Float
  startTime   DateTime?
  endTime     DateTime?
  maxPeople   Int?
  imageUrl    String?

  // Pricing fields
  isFree      Boolean        @default(true)
  price       Float          @default(0)  // Amount in cents (e.g., 1500 = $15.00)
  currency    String         @default("SGD")

  // PayNow payment fields
  paynowEnabled  Boolean     @default(false)
  paynowNumber   String?     // Phone number for PayNow
  paynowName     String?     // Name for PayNow verification
  paynowQrCode   String?     // URL to PayNow QR code image

  // Stripe payment fields
  stripeEnabled  Boolean     @default(false)
  stripePriceId  String?     // Stripe Price ID for checkout

  status      ActivityStatus @default(PUBLISHED)
  userId      String
  hostId      String?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  deletedAt   DateTime?

  user           User             @relation("CreatedActivities", fields: [userId], references: [id], onDelete: Cascade)
  host           User?            @relation("HostedActivities", fields: [hostId], references: [id], onDelete: SetNull)
  userActivities UserActivity[]
  groups         Group[]

  @@index([userId])
  @@index([hostId])
  @@index([type])
  @@index([city])
  @@index([startTime])
  @@index([title])
  @@index([status])
  @@map("activities")
}

model Group {
  id          String       @id @default(cuid())
  name        String
  description String?
  privacy     GroupPrivacy @default(PUBLIC)
  activityId  String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  deletedAt   DateTime?

  activity Activity?   @relation(fields: [activityId], references: [id], onDelete: SetNull)
  members  UserGroup[]
  messages Message[]

  @@index([activityId])
  @@map("groups")
}

model Message {
  id        String    @id @default(cuid())
  content   String
  groupId   String
  userId    String
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  group    Group     @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  mentions Mention[]

  @@index([groupId])
  @@index([userId])
  @@map("messages")
}

model UserGroup {
  id        String    @id @default(cuid())
  userId    String
  groupId   String
  role      UserRole  @default(MEMBER)
  joinedAt  DateTime  @default(now())
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  group Group @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@unique([userId, groupId])
  @@index([userId])
  @@index([groupId])
  @@map("user_groups")
}

model UserActivity {
  id         String             @id @default(cuid())
  userId     String
  activityId String
  status     UserActivityStatus @default(INTERESTED)
  createdAt  DateTime           @default(now())
  updatedAt  DateTime           @updatedAt
  deletedAt  DateTime?

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  activity Activity @relation(fields: [activityId], references: [id], onDelete: Cascade)

  @@unique([userId, activityId])
  @@index([userId])
  @@index([activityId])
  @@index([status])
  @@map("user_activities")
}

model Notification {
  id        String           @id @default(cuid())
  userId    String
  type      NotificationType
  title     String
  content   String
  link      String?
  isRead    Boolean          @default(false)
  metadata  Json?
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  user User @relation("UserNotifications", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@map("notifications")
}

model Mention {
  id                String   @id @default(cuid())
  messageId         String
  mentionedUserId   String
  mentionedByUserId String
  mentionText       String
  createdAt         DateTime @default(now())

  message       Message @relation(fields: [messageId], references: [id], onDelete: Cascade)
  mentionedUser User    @relation("MentionsReceived", fields: [mentionedUserId], references: [id], onDelete: Cascade)
  mentionedBy   User    @relation("MentionsSent", fields: [mentionedByUserId], references: [id], onDelete: Cascade)

  @@index([messageId])
  @@index([mentionedUserId])
  @@index([mentionedByUserId])
  @@map("mentions")
}

model NotificationPreference {
  id               String   @id @default(cuid())
  userId           String   @unique
  mentionEnabled   Boolean  @default(true)
  messageEnabled   Boolean  @default(true)
  activityEnabled  Boolean  @default(true)
  emailEnabled     Boolean  @default(false)
  pushEnabled      Boolean  @default(false)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notification_preferences")
}
